---
import Layout from "../layouts/Layout.astro";
import client from "../../tina/__generated__/client";

// Fetch homepage content
const homepageResponse = await client.queries.homepage({ relativePath: "index.json" });
const homepage = homepageResponse.data.homepage;

// Fetch capabilities content
const capsResponse = await client.queries.capabilities({ relativePath: "index.json" });
const tabs = capsResponse.data.capabilities.tabs;

// Fetch site settings
const settingsResponse = await client.queries.siteSettings({ relativePath: "index.json" });
const settings = settingsResponse.data.siteSettings;

// SEO
const seo = homepage.seo;
const pageTitle = seo?.metaTitle || "Vian | Growth Marketer";
const pageDescription = seo?.metaDescription || "Growth Marketer | SE Asia";
const ogImage = seo?.ogImage || "";

// Prepare logo set for conveyor belt (triple the list so it fills the viewport width)
const companies = homepage.companies?.filter(Boolean) || [];
const logoSet = [...companies, ...companies, ...companies];

// Helper: collect non-empty images from separate fields into an array
function getMetricImages(metric: any): string[] {
  return [metric.image1, metric.image2, metric.image3].filter((img): img is string => !!img);
}
---

<Layout title={pageTitle} description={pageDescription} ogImage={ogImage}>
  <!-- Masthead Navigation -->
  <header
    class="w-full border-b border-[#E5E2DC] px-6 py-5 md:px-16 flex items-center justify-between"
  >
    <div class="flex items-center gap-8">
      <!-- Logo -->
      <span class="font-display font-bold text-2xl text-[#1A1A1A] tracking-logo">
        {settings.logoText || "VIAN"}
      </span>

      <!-- Navigation -->
      <nav class="hidden md:flex items-center gap-6">
        <a
          href="#"
          class="text-xs font-semibold text-[#1A1A1A] tracking-nav flex items-center gap-2"
        >
          <span class="w-1.5 h-1.5 rounded-full bg-[#1A1A1A]"></span>
          Overview
        </a>
        <a href="#capabilities" class="text-xs text-[#999999] tracking-nav hover:text-[#1A1A1A] transition-colors">
          Capabilities
        </a>
        <a href="#" class="text-xs text-[#999999] tracking-nav hover:text-[#1A1A1A] transition-colors">
          About
        </a>
      </nav>
    </div>

    <div class="flex items-center gap-4">
      <!-- Resume Button -->
      <a
        href={settings.resumeFile || "/resume.pdf"}
        download
        class="hidden md:flex items-center gap-2 bg-[#1A1A1A] text-white text-[11px] font-semibold tracking-section px-4 py-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="14"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        RESUME
      </a>

    </div>
  </header>

  <main class="w-full max-w-[1440px] mx-auto flex flex-col">
    <!-- Topfold -->
    <section class="flex flex-col items-center gap-8 px-6 pt-16 pb-2 md:px-20 md:pt-16 md:pb-2">
      {/* Photo — hidden when no image is uploaded */}
      {homepage.photo && (
        <div
          class="w-36 h-36 md:w-40 md:h-40 rounded-full shadow-md overflow-hidden flex-shrink-0 hover:shadow-lg transition-shadow duration-300"
        >
          <img src={homepage.photo} alt={homepage.headline} class="w-full h-full object-cover" />
        </div>
      )}

      <!-- Headline -->
      <h1 class="font-display text-4xl md:text-5xl font-normal text-[#1A1A1A] tracking-[-1px] text-center">
        {homepage.headline}
      </h1>

      <!-- Subtitle -->
      <p class="text-sm font-medium text-[#999999] tracking-[1px] text-center">
        {homepage.subtitle}
      </p>

      <!-- "Shipped results for" label -->
      {companies.length > 0 && (
        <span class="text-[13px] text-[#666666]">{homepage.shippedResultsLabel}</span>
      )}
    </section>

    <!-- Company Logo Conveyor Belt -->
    {companies.length > 0 && (
      <div class="logo-conveyor relative w-full overflow-hidden pt-2 pb-6">
        <div class="logo-track flex items-center gap-12 md:gap-16">
          {/* Set 1 */}
          {logoSet.map((company) => (
            <div class="flex-shrink-0">
              {company.logo ? (
                <img
                  src={company.logo}
                  alt={company.name}
                  class="h-8 md:h-9 w-auto object-contain grayscale opacity-60"
                  loading="lazy"
                />
              ) : (
                <span class="text-base font-bold text-[#1A1A1A] opacity-40 whitespace-nowrap">{company.name}</span>
              )}
            </div>
          ))}
          {/* Set 2 (identical duplicate for seamless loop) */}
          {logoSet.map((company) => (
            <div class="flex-shrink-0">
              {company.logo ? (
                <img
                  src={company.logo}
                  alt={company.name}
                  class="h-8 md:h-9 w-auto object-contain grayscale opacity-60"
                  loading="lazy"
                />
              ) : (
                <span class="text-base font-bold text-[#1A1A1A] opacity-40 whitespace-nowrap">{company.name}</span>
              )}
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- About -->
    <section class="flex flex-col items-center gap-8 px-6 pb-16 md:px-20">
      <h2 class="text-[30px] font-medium text-[#1A1A1A] text-center">{homepage.aboutHeading || "About"}</h2>
      <div class="flex flex-col gap-3 max-w-3xl">
        {homepage.aboutText.split("\n\n").map((paragraph: string) => (
          <p class="text-[15px] text-[#666666] leading-[1.7] text-center">
            {paragraph}
          </p>
        ))}
      </div>

      <!-- Scroll CTA -->
      <a href="#capabilities" class="text-xs font-medium text-[#999999] tracking-[0.5px] hover:text-[#666666] transition-colors">
        ↓&ensp;See Projects
      </a>
    </section>

    <!-- Capability Tabs Section -->
    <section id="capabilities" class="flex flex-col gap-8 px-6 py-12 md:px-20">
      <!-- Section Heading -->
      <h2 class="text-[30px] font-medium text-[#1A1A1A]">
        Projects
      </h2>

      <!-- Tab Navigation -->
      <div class="flex items-center border-b border-[#E5E2DC]">
        {
          tabs.map((tab, i) => (
            <button
              data-tab={tab.id}
              class={`tab-btn px-4 py-3 text-[12px] tracking-[0.5px] border-b-2 transition-all cursor-pointer ${
                i === 0
                  ? "font-semibold text-[#1A1A1A] border-[#1A1A1A]"
                  : "font-medium text-[#999999] border-transparent hover:text-[#666666]"
              }`}
            >
              {tab.label}
            </button>
          ))
        }
      </div>

      <!-- Tab Content Panels -->
      {
        tabs.map((tab, i) => (
          <div
            data-panel={tab.id}
            class={`tab-panel ${i === 0 ? "" : "hidden"}`}
          >
            <div class="grid grid-cols-1 md:grid-cols-2">
              {/* Metrics Column */}
              <div class="flex flex-col md:pr-8">
                {tab.metrics.map((metric, j) => (
                  <div
                    class={`metric-row relative flex items-start gap-4 py-5 border-b border-[#E5E2DC] cursor-pointer transition-opacity duration-300 ${j === 0 ? "" : "opacity-[0.35]"}`}
                    data-metric-idx={String(j)}
                  >
                    <div class="flex-1 min-w-0">
                      {/* Mobile: images above metric number */}
                      {(() => {
                        const imgs = getMetricImages(metric);
                        return imgs.length > 0 && (
                          <div class="md:hidden mb-3">
                            <div class="image-scroll flex gap-3 overflow-x-auto snap-x snap-mandatory pb-3 -mr-6 pr-6" style="-webkit-overflow-scrolling: touch;">
                              {imgs.map((img) => (
                                <div class="flex-shrink-0 w-[200px] h-[150px] rounded-lg shadow-md overflow-hidden snap-start">
                                  <img src={img} alt="" class="w-full h-full object-cover" loading="lazy" />
                                </div>
                              ))}
                            </div>
                            {imgs.length > 1 && (
                              <div class="image-dots flex justify-center gap-1.5 mt-2">
                                {imgs.map((_, idx) => (
                                  <div class={`dot w-1.5 h-1.5 rounded-full transition-colors duration-200 ${idx === 0 ? 'bg-[#666666]' : 'bg-[#E5E2DC]'}`}></div>
                                ))}
                              </div>
                            )}
                          </div>
                        );
                      })()}

                      <span
                        class="font-mono text-3xl font-semibold tracking-[-1px]"
                        style={`color: ${tab.accent}`}
                      >
                        {metric.highlight}
                      </span>
                      <p class="text-[13px] text-[#666666] leading-[1.5] mt-1">
                        {metric.description}
                      </p>
                    </div>
                    <a
                      href={metric.url || "#"}
                      class="metric-chevron w-10 h-10 rounded-full border border-[#E5E2DC] flex items-center justify-center flex-shrink-0 hover:border-[#999999] transition-colors relative"
                      aria-label="View case study"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#999999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                      </svg>
                      {metric.url?.startsWith("http") && (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="8"
                          height="8"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="#999999"
                          stroke-width="2.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="absolute top-1 right-1"
                        >
                          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                          <polyline points="15 3 21 3 21 9"></polyline>
                          <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                      )}
                    </a>
                    {/* Progress bar overlays border-bottom */}
                    <div class="absolute bottom-0 left-0 right-0 h-[2px]">
                      <div
                        class="metric-progress-bar h-full w-0"
                        style={`background-color: ${tab.accent}`}
                      ></div>
                    </div>
                  </div>
                ))}
              </div>

              {/* Detail Column (desktop only) */}
              <div class="hidden md:flex md:border-l md:border-[#E5E2DC] md:pl-8">
                <div class="grid flex-1 items-center">
                  {tab.metrics.map((metric, j) => (
                    <div
                      class={`metric-detail col-start-1 row-start-1 flex flex-col gap-6 justify-center transition-opacity duration-300 ${j === 0 ? "opacity-100" : "opacity-0 pointer-events-none"}`}
                      data-detail-idx={String(j)}
                    >
                      {/* Desktop: images in detail panel */}
                      {(() => {
                        const imgs = getMetricImages(metric);
                        return imgs.length > 0 && (
                          <div class={`flex gap-3 ${imgs.length === 1 ? 'justify-center' : ''}`}>
                            {imgs.map((img) => (
                              <div
                                class={`rounded-lg shadow-md overflow-hidden ${
                                  imgs.length === 1 ? 'w-[65%]' : 'flex-1'
                                }`}
                                style="height: 250px;"
                              >
                                <img src={img} alt="" class="w-full h-full object-cover" loading="lazy" />
                              </div>
                            ))}
                          </div>
                        );
                      })()}

                      <p class="text-[15px] text-[#666666] leading-[1.7]">
                        {metric.detail}
                      </p>
                      <a
                        href={tab.ctaUrl || "#"}
                        class="inline-flex items-center gap-2 text-[12px] font-semibold tracking-[0.5px] hover:opacity-70 transition-opacity w-fit"
                        style={`color: ${tab.accent}`}
                      >
                        {tab.ctaText}
                        {tab.ctaUrl?.startsWith("http") ? (
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="12"
                            height="12"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                          </svg>
                        ) : (
                          <span>→</span>
                        )}
                      </a>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </section>
  </main>

  <!-- Footer -->
  <footer class="w-full border-t border-[#E5E2DC] px-6 py-8 md:px-16">
    <div class="max-w-[1440px] mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <span class="text-xs text-[#999999]">
        &copy; {settings.footerCopyright}
      </span>
      <span class="text-xs text-[#999999]">
        {settings.footerLocation}
      </span>
    </div>
  </footer>
  <script>
    const ROTATION_MS = 7000;
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');

    let currentTab = 'pmm';
    const activeIdx: Record<string, number> = {};
    const timers: Record<string, ReturnType<typeof setTimeout> | null> = {};

    // Initialize metric index for each tab
    tabPanels.forEach((panel) => {
      activeIdx[panel.getAttribute('data-panel')!] = 0;
    });

    function activateMetric(tabId: string, index: number) {
      const panel = document.querySelector(`[data-panel="${tabId}"]`);
      if (!panel) return;

      activeIdx[tabId] = index;

      // Dim/highlight metric rows
      panel.querySelectorAll('.metric-row').forEach((row, i) => {
        (row as HTMLElement).style.opacity = i === index ? '1' : '0.35';
      });

      // Fade detail panels
      panel.querySelectorAll('.metric-detail').forEach((detail, i) => {
        if (i === index) {
          detail.classList.remove('opacity-0', 'pointer-events-none');
          detail.classList.add('opacity-100');
        } else {
          detail.classList.remove('opacity-100');
          detail.classList.add('opacity-0', 'pointer-events-none');
        }
      });

      // Progress bar: reset then fill over ROTATION_MS
      panel.querySelectorAll('.metric-progress-bar').forEach((bar, i) => {
        (bar as HTMLElement).style.transition = 'none';
        (bar as HTMLElement).style.width = '0%';
        if (i === index) {
          void (bar as HTMLElement).offsetHeight; // force reflow
          (bar as HTMLElement).style.transition = `width ${ROTATION_MS}ms linear`;
          (bar as HTMLElement).style.width = '100%';
        }
      });
    }

    function startRotation(tabId: string) {
      stopRotation(tabId);
      const metricCount = document.querySelector(`[data-panel="${tabId}"]`)?.querySelectorAll('.metric-row').length || 3;
      timers[tabId] = setTimeout(() => {
        const next = ((activeIdx[tabId] || 0) + 1) % metricCount;
        activateMetric(tabId, next);
        startRotation(tabId);
      }, ROTATION_MS);
    }

    function stopRotation(tabId: string) {
      if (timers[tabId]) {
        clearTimeout(timers[tabId]!);
        timers[tabId] = null;
      }
    }

    // Tab switching
    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const tabId = btn.getAttribute('data-tab')!;
        if (tabId === currentTab) return;

        stopRotation(currentTab);

        // Update tab button states
        tabButtons.forEach((b) => {
          b.classList.remove('font-semibold', 'text-[#1A1A1A]', 'border-[#1A1A1A]');
          b.classList.add('font-medium', 'text-[#999999]', 'border-transparent');
        });
        btn.classList.remove('font-medium', 'text-[#999999]', 'border-transparent');
        btn.classList.add('font-semibold', 'text-[#1A1A1A]', 'border-[#1A1A1A]');

        // Show/hide panels
        tabPanels.forEach((p) => {
          if (p.getAttribute('data-panel') === tabId) {
            p.classList.remove('hidden');
          } else {
            p.classList.add('hidden');
          }
        });

        currentTab = tabId;
        activeIdx[tabId] = 0;
        activateMetric(tabId, 0);
        startRotation(tabId);
      });
    });

    // Metric row click — manual override
    document.querySelectorAll('.metric-row').forEach((row) => {
      row.addEventListener('click', (e) => {
        // Don't trigger if chevron link was clicked
        if ((e.target as HTMLElement).closest('.metric-chevron')) return;

        const panel = row.closest('.tab-panel')!;
        const tabId = panel.getAttribute('data-panel')!;
        const idx = parseInt(row.getAttribute('data-metric-idx')!);

        stopRotation(tabId);
        activateMetric(tabId, idx);
        startRotation(tabId);
      });
    });

    // Chevron click — prevent row click from firing
    document.querySelectorAll('.metric-chevron').forEach((chevron) => {
      chevron.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });

    // Boot: activate first metric on first tab
    const firstTabId = document.querySelector('.tab-panel')?.getAttribute('data-panel');
    if (firstTabId) {
      activateMetric(firstTabId, 0);
      startRotation(firstTabId);
    }

    // Image scroll dot indicators (mobile)
    document.querySelectorAll('.image-scroll').forEach((scroller) => {
      const dotsContainer = scroller.parentElement?.querySelector('.image-dots');
      if (!dotsContainer) return;
      const dots = dotsContainer.querySelectorAll('.dot');
      const items = scroller.querySelectorAll(':scope > div');
      if (items.length <= 1) return;

      scroller.addEventListener('scroll', () => {
        const scrollLeft = scroller.scrollLeft;
        const itemWidth = (items[0] as HTMLElement).offsetWidth + 12; // 12 = gap-3
        const activeIndex = Math.round(scrollLeft / itemWidth);
        dots.forEach((dot, i) => {
          if (i === activeIndex) {
            dot.classList.remove('bg-[#E5E2DC]');
            dot.classList.add('bg-[#666666]');
          } else {
            dot.classList.remove('bg-[#666666]');
            dot.classList.add('bg-[#E5E2DC]');
          }
        });
      }, { passive: true });
    });
  </script>
</Layout>
