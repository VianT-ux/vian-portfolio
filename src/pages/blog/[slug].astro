---
import Layout from "../../layouts/Layout.astro";
import RichTextRenderer from "../../components/RichTextRenderer.astro";
import client from "../../../tina/__generated__/client";

export async function getStaticPaths() {
  const response = await client.queries.blogPostConnection();
  const posts = response.data.blogPostConnection.edges || [];

  return posts.map((edge: any) => {
    const slug = edge.node._sys.filename;
    return {
      params: { slug },
      props: { relativePath: `${slug}.mdx` },
    };
  });
}

const { relativePath } = Astro.props;
const response = await client.queries.blogPost({ relativePath });
const post = response.data.blogPost;

const seo = post.seo;
const pageTitle = seo?.metaTitle || `${post.title} | Vian`;
const pageDescription = seo?.metaDescription || post.excerpt || "";
const ogImage = seo?.ogImage || post.coverImage || "";

const publishedDate = post.publishedDate
  ? new Date(post.publishedDate).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    })
  : null;
---

<Layout title={pageTitle} description={pageDescription} ogImage={ogImage}>
  <main class="w-full max-w-[720px] mx-auto px-6 py-16 md:px-8">
    <!-- Back link -->
    <a
      href="/"
      class="inline-flex items-center gap-2 text-[12px] font-medium text-[#999999] tracking-[0.5px] hover:text-[#666666] transition-colors mb-12"
    >
      <span>‚Üê</span> Back to portfolio
    </a>

    <!-- Header -->
    <header class="mb-12">
      {publishedDate && (
        <time class="text-[12px] text-[#999999] tracking-[0.5px] mb-3 block">
          {publishedDate}
        </time>
      )}
      <h1 class="font-display text-3xl md:text-4xl font-normal text-[#1A1A1A] tracking-[-1px] mb-4">
        {post.title}
      </h1>
      {post.excerpt && (
        <p class="text-[15px] text-[#666666] leading-[1.7]">
          {post.excerpt}
        </p>
      )}
      {post.tags && post.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-4">
          {post.tags.map((tag: string) => (
            <span class="text-[11px] font-medium text-[#666666] bg-[#F5F2ED] px-3 py-1">
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>

    {/* Cover image */}
    {post.coverImage && (
      <img
        src={post.coverImage}
        alt={post.title}
        class="w-full border border-[#E5E2DC] mb-12"
        loading="lazy"
      />
    )}

    {/* Body */}
    <article>
      <RichTextRenderer content={post.body} />
    </article>
  </main>
</Layout>
